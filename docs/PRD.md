Телеграм-бот «Квесты Развития»

**Версия:** 1.0
**Дата:** 07.09.2025

## 1\. Введение и цель

Этот документ описывает требования к MVP (Minimum Viable Product) телеграм-бота «Квесты Развития».

**Цель продукта:** Предоставить родителям ежедневный, простой и сфокусированный набор задач для развития детей, основанный на заранее подготовленном списке навыков. Бот снимает с пользователя когнитивную нагрузку по выбору активностей на день.

## 2\. Ключевые характеристики

  * **Аудитория:** Родители (изначально — одна семья).
  * **Персонажи:** Даня (06.03.2020), Тема (25.02.2022).
  * **Основной сценарий:** Ежедневная автоматическая отправка сообщения с тремя задачами для каждого ребенка всем подписанным пользователям.

## 3\. Рекомендуемый стек

  * **Фреймворк:** Next.js (с использованием API Routes для бэкенда).
  * **Язык:** TypeScript.
  * **UI (при необходимости):** Tailwind CSS.
  * **Хостинг:** Vercel (или любая платформа с поддержкой Node.js, cron-jobs и переменных окружения).

## 4\. Функциональные требования (User Stories)

### Epic: User Onboarding & Management

  * **Story 10 (Subscription):** Как пользователь, я могу отправить команду `/start`, чтобы подписаться на ежедневную рассылку. Система должна сохранить мой `chat_id`.
  * **Story 11 (Welcome Message):** Как пользователь, после отправки `/start` я получаю приветственное сообщение с описанием работы бота.
      * **Текст сообщения:**
        > Привет\! Это бот для развития Дани и Темы.
        > Каждый день в 7 утра по португальскому времени я буду присылать по три фокуса развития для каждого из их плана развития.
  * **Story 14 (Unsubscription):** Как пользователь, я могу отправить команду `/stop`, чтобы отписаться от рассылки. Система должна удалить мой `chat_id` из списка подписчиков.

### Epic: Data Handling

  * **Story 1 (Parsing):** Система при инициализации парсит два локальных `.md` файла (`Dans_current_development_progress.md`, `Temas_current_development_progress.md`), извлекая из них все строки с синтаксисом `[ ] Task text` для формирования двух независимых пулов задач.
  * **Story 2 (Persistence):** Система использует локальный `db.json` файл для хранения:
    1.  Пулов задач для каждого персонажа, включая статусы отправки в текущем цикле.
    2.  Списка `chat_id` всех подписанных пользователей.
  * **Story 8 (Error Handling):** Если при парсинге файла для одного из персонажей возникает ошибка (файл не найден, пуст, нет задач), система отправляет пользователям сообщение об ошибке для этого персонажа, но продолжает штатную обработку для второго.
      * **Формат сообщения об ошибке:**
        ```
        Для Дани:
        * [x] Ошибка: не удалось загрузить задачи. Проверьте исходный файл.

        Для Тёмы:
        * [ ] Задача 1
        * [ ] Задача 2
        * [ ] Задача 3
        ```

### Epic: Core Logic

  * **Story 3 (Scheduling):** Система запускает cron-job ежедневно в 07:00 WEST.
  * **Story 4 (Selection):** Cron-job выбирает по 3 случайные задачи из каждого пула, которые еще не были отправлены в текущем цикле.
  * **Story 5 (State Update):** После выбора задачи помечаются как "отправленные" в `db.json` для текущего цикла.
  * **Story 6 (Cycle Reset):** Когда пул задач полностью исчерпан, система автоматически сбрасывает статусы "отправлено" для всех задач в этом пуле, запуская цикл заново.

### Epic: Notification

  * **Story 7 (Broadcast):** Cron-job итерируется по списку `chat_id` подписчиков и отправляет одно и то же сформированное сообщение каждому из них.
      * **Формат сообщения:**
        ```
        Для Дани:

        * [ ] Текст задачи 1
        * [ ] Текст задачи 2
        * [ ] Текст задачи 3

        Для Тёмы:

        * [ ] Текст задачи 1
        * [ ] Текст задачи 2
        * [ ] Текст задачи 3
        ```

### Epic: Operations

  * **Story 9 (Content Update):** Администратор обновляет список задач путем прямого редактирования `.md` файлов в Git-репозитории с последующим redeploy приложения.
  * **Story 12 (Configuration):** Секреты (`TELEGRAM_BOT_TOKEN`) и конфигурация (`TELEGRAM_CHAT_ID` для админа, если нужно) управляются через переменные окружения, с поддержкой `.env` для локальной разработки.
  * **Story 13 (Logging):** Система ведет детальный консольный лог ключевых шагов cron-job (старт, результат парсинга, количество выбранных задач, статус отправки) для упрощения отладки.

## 5\. Нефункциональные требования

  * **Архитектура:** Single-tenant. Все параметры (имена детей, пути к файлам) жестко заданы в конфигурации.
  * **Приватность:** Система подписки открыта для любого пользователя, нашедшего бота.